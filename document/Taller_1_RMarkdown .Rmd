---
title: "Problem Set 1 RMarkdown"
author: "Irina Vélez - Lucía Fillippo - Daniel Casas - Miguel Victoria"
date: "2023-06-21"
output: word_document
---
```{r setup, include=FALSE}
rm(list = ls())
# install pacman
if(!require(pacman)) install.packages("pacman") ; require(pacman)

## Automatiza cargue de paquetes
require(pacman)
p_load(rio, 
       tidyverse, 
       skimr,
       caret,
       rstudioapi,
       rvest,
       ggplot2) 
```

```{r path, include=FALSE}
rm(list=ls())
getwd()
path_sript <- rstudioapi::getActiveDocumentContext()$path
path_folder <- dirname(path_sript)
setwd(path_folder)
```

```{r Import_data, eval=FALSE, include=FALSE}
### Loading data  
data_url = "https://ignaciomsarmiento.github.io/GEIH2018_sample/pages/geih_"

# Loop
db_list <- lapply(1:10, function(i) {
  url <- paste0(data_url, "page_", i, ".html")
  page <- read_html(url) 
  tabla <- page %>% html_table
  db_geih <- data.frame(tabla)
})

db_geih <- do.call(rbind,db_list) # Concatenate the tables in a dataframe
view(db_geih)
```

```{r Transforming_data, eval=FALSE, include=FALSE}
##Filtering the data to those over 18 and employed (ocu=1)
# Details of the variable age 
summary(db_geih$age)
sum(is.na(db_geih$age)) # Checking for missing values
sum(is.na(db_geih$ocu))

db_geih_filtered <- db_geih[db_geih$age > 18 & db_geih$ocu == 1, ]
save(db_geih_filtered, file = "/Users/irina/Documents/Repositorios/PS1_Predicting_income/stores/data.Rdata")

## Dealing with missing values
# Count missing values for each column and sorting
missing_counts <- sapply(db_geih_filtered, function(x) sum(is.na(x)))
sorted_missing <- sort(missing_counts, decreasing = TRUE)
top_missing <- head(sorted_missing, 30)
top_missing

# Deleting the top missing variables and all variables that start with cclasnr
delete_var <- c("p550", "p7310", "p7350", "p7422", "p7422s1", "p7472", "p7472s1", "ina", "imdi", "imdies", "y_gananciaNetaAgro_m", "iof3ies", "y_accidentes_m", "p6585s4a2", "y_subEducativo_m", "isaes", "iof2es", "dominio", "clase")
delete_var2 <- grep("^cclasnr", names(db_geih_filtered), value = TRUE)
delete_t <- c(delete_var, delete_var2)

geih_filtered <- db_geih_filtered %>%
  select(-one_of(delete_t))

## Dealing with 0 wages

# Verification of the min and max value of the main resultant variables, and their missing values
summary(geih_filtered$p6500)           # Monthly labor income. DANE Variable
summary(geih_filtered$y_ingLab_m)      # labor income salaried nominal monthly
summary(geih_filtered$y_ingLab_m_ha)   # labor income salaried nominal hourly
summary(geih_filtered$y_salary_m)      # salary - nominal monthly
summary(geih_filtered$y_salary_m_hu)   # salary - real hourly (usual)

missing_income <- sum(is.na(geih_filtered$y_ingLab_m_ha))
obs <- nrow(geih_filtered)

# The 40.32% of the observations for the main resultant variables have missing values
missing_perc = (missing_income/obs)*100
missing_perc

missing_values <- is.na(geih_filtered$y_salary_m_hu)
missing_data <- geih_filtered[missing_values, c("estrato1", "maxEducLevel")]

missing_by_estrato <- table(missing_data$estrato1)
missing_by_educ <- table(missing_data$maxEducLevel)


missing_by_estrato <- sort(missing_by_estrato, decreasing = TRUE)
missing_by_educ <- sort(missing_by_educ, decreasing = TRUE)

missing_by_estrato_p <- missing_by_estrato / sum(missing_by_estrato) * 100
missing_by_educ_p <- missing_by_educ / sum(missing_by_educ) * 100

missing_by_estrato_p
missing_by_educ_p

# Data frame with the results
results <- data.frame(estrato = names(missing_by_estrato_p),
                      educacion = names(missing_by_educ_p),
                      p_missing_estrato = missing_by_estrato_p,
                      p_missing_educacion = missing_by_educ_p)

knitr::kable(results, caption = "Missing Values by Estrato and Educación")

geih_filtered <- geih_filtered[complete.cases(geih_filtered$y_salary_m_hu), ]
save(geih_filtered, file = "/Users/irina/Documents/Repositorios/PS1_Predicting_income/stores/data.Rdata")
```

```{r Import_DB, include=FALSE}
load("../stores/data.Rdata")
geih_filtered <- geih_filtered[complete.cases(geih_filtered$maxEducLevel), ]
```

# Taller 1

El presente informe presenta la solución al Problem Set 1 de la clase Big Data & Machine Learning, en donde se aplicaron diversos conceptos y herramientas para la predicción de modelos, el manejo de bases de datos grandes, entre otros. El repositorio GitHub se encuentra este documento y el código R, en donde se generaron todos los resultados. Este repositorio se encuentra en el siguiente link: (link del Github con el código)

## 1. Introducción

Conocer el valor de los ingresos de las personas es fundamental para el pago de impuestos y para identificar a los hogares que requieren apoyos sociales; no obstante, en algunas ocasiones estos valores no se conocen al no ser reportados, de manera que poder determinar su valor se convierte en un gran insumo para el desarrollo de políticas tributarias y sociales. Con objeto de lo anterior, el objetivo principal de este documento es construir un modelo predictivo de los salarios por hora de los individuos, a partir del siguiente modelo:

$$
w=f(X)+u
$$

donde w representa el salario por hora y X es una matriz de potenciales variables que explican el salario. Para la creación de este modelo se utilizarán datos de la Gran Encuesta Integrada de Hogares – GEIH del año 2018. 

Para importar los datos, es importante conocer qué tipo de página web contiene la información, en este caso, la página web que contiene las bases de datos es dinámica, por lo que es pertinente identificar el link principal del cual se realizará la extracción de la información; además, se apliará un código en bucle para que la extracción de la informacíon sea más eficiente.Por último, como fue indicado, se realiza un primer filtro para tener en cuenta únicamente los individuos mayores de 18 años.

# Descripción de los datos
## Descripción general

Aquí va el texto
```{r general_description, echo=FALSE}
# Aquí hacemos la clasificación de variables
exp <- floor(c(geih_filtered$p6426/12)) #Ponemos anual la variable de experiencia
DGEIH<-subset(geih_filtered, select = c( "y_salary_m_hu", "pet", "mes", "age", "sex","ocu", "oficio", "maxEducLevel","totalHoursWorked")) 

#Hacemos un subset con las variables a usar
DGEIH<-cbind(DGEIH, exp) #Incluimos las variables calculadas que revisaremos

summary(DGEIH)
```

## Descripción edad

Aquí va el texto
```{r age_description, echo=FALSE}
# (1) Descripción general de la base
dimen_dgeih <- dim(DGEIH)  #Número de filas y columnas

# (2) Descripción de la variable de edad
Edad<- DGEIH$age
edad_clas <- class(Edad)         #Aquí vemos la clase y nos dice que es de números enteros (integer)
edad_media <- mean(Edad)          #Edad media: nos dice que es 42.95
edad_min <- min(Edad)           #Edad mínima: 19
edad_max <- max(Edad)           #Edad máxima: 106 años
modeEdad <- function(Edad){
  return(as.numeric(names(which.max(table(Edad)))))
}
edad_mod <- modeEdad(Edad)      #La moda de la edad es 25 años

# Ahora haremos un diagrama de barras 
# Crearemos un data frame con los datos de edad
datos_edad <- data.frame(Edad)

# Crearemos el diagrama de barras
bar_chart <- ggplot(datos_edad, aes(x = Edad)) +
  geom_bar(fill = "#2E75B6", color = "white") +
  labs(x = "Edad", y = "Frecuencia", title = "Distribución de Edad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

# Que nos muestre el diagrama de barras
print(bar_chart)
summary(Edad)
```

## Descripción ocupación

Aquí va el texto
```{r ocup_description, echo=FALSE}
# (4) Descripción de la variable de ocupación
ocu<- DGEIH$ocu
ocup_clas <- class(ocu)          #Aquí vemos la clase y nos dice que es categórica (factor)
ocup_clas <- levels(ocu)         #Como es categórica y tiene nivel 0 y 1         

#Creamos un data frame con los datos de ocupación
datos_ocu <- data.frame(
  Categoría = c("Ocupadas", "No Ocupadas"),
  Cantidad = c(16277, 3524)
)

#Calculamos los porcentajes
datos_ocu$Porcentaje <- round(datos_ocu$Cantidad / sum(datos_ocu$Cantidad) * 100, 1)

#Creamos el diagrama de pie
pie_chart <- ggplot(datos_ocu, aes(x = "", y = Cantidad, fill = Categoría)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        plot.margin = margin(0, 0, 0, 0)) +
  geom_text(aes(label = paste0(Categoría, "\n", Porcentaje, "%")), 
            position = position_stack(vjust = 0.5), size = 3, color = "white")

#Que nos muestre el diagrama de pie
print(pie_chart)
summary(ocu)  
```

## Descripción educación

Aquí va el texto
```{r educ_description, echo=FALSE}
# (5) Descripción de la variable de educación

# Datos en la variable:
#1 Ninguno
#2 Preescolar
#3 Basica primaria (1o - 5o)
#4 Basica secundaria (60 - 9o)
#5 Media (10o -13o)
#6 Superior - Universitaria
#7 No sabe, No informa


educ<- DGEIH$maxEducLevel
educ_cals <- class(educ)  #Nos dice que es de números enteros (integer)
modeEduc <- function(educ){
  return(as.numeric(names(which.max(table(educ)))))
}
mod_educ <- modeEduc(educ)      #La moda de la educación es 7 (terciary)

## Ahora vamos a hacer una gráfica de barras que refleje la cantidad de personas que tienen cada nivel de educación
## Se utilizarán abreviaturas de las siguiente manera:
#1 "None"                         = "none
#2 "preschool"                    = "pre"
#3 "primary incomplete (1-4)"     = "pri_in"
#4 "primary complete (5)"         = "pri_com"
#5 "secondary incomplete (6-10)"  = "sec_in"
#6 "secondary complete (11)"      = "sec_com"
#7 "terciary"                     = "ter"
#9 "N/A";                         = "N/A"... aunque no hay en la base ya limpia

# Creamos el data frame
datos_educ <- data.frame(educ)

# Creamos el diagrama de barras con etiquetas de datos y demás
bar_chart <- ggplot(datos_educ, aes(x = as.factor(educ))) +
  geom_bar(fill = "#2E75B6", color = "white") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 3, color = 'black') +  # Agregar etiquetas de datos
  labs(x = "Educ", y = "Frecuencia", title = "Distribución de Educación") +
  scale_x_discrete(labels = c("Ninguno", "Preescolar", "Basc_prim", "Basc_secund", "Media", "Universitaria", "No_informa")) +  # Cambiar las categorías del eje x
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 8),
        axis.line.y = element_blank(),  # Eliminar el eje vertical izquierdo
        axis.ticks.y = element_blank(),  # Eliminar los ticks del eje vertical izquierdo
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

# Hacemos que nos muestre el diagrama de barras
print(bar_chart)
summary(educ)
table(educ)
```

## Descripción sexo

Aquí va el texto
```{r sex_description, echo=FALSE}
# (5) Descripción de la variable de sex

# Datos en la variable:
#0 Mujer
#1 Hombre

# (6) Descripción de la variable de género
sex<- DGEIH$sex
sex_clas <- class(sex)      #Aquí vemos la clase y nos dice que es integer, es una variable dummy
sex_tabl <- table(sex)
# Creamos un data frame con los datos de sexo
datos_sex <- data.frame(
  Categoría = c("Hombres", "Mujeres"),
  Cantidad = c(4910, 4874)
)

# Crear el diagrama de pie con etiquetas de datos
pie_chart <- ggplot(datos_sex, aes(x = "", y = Cantidad, fill = Categoría)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  geom_text(aes(label = Cantidad), position = position_stack(vjust = 0.5), size = 4) +  # Etiquetas de datos en valores enteros
  coord_polar("y", start = 0) +
  labs(title = "Distribución por género") +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        legend.position = "right")

# Mostrar el diagrama de pie
print(pie_chart)
table(sex)
summary(sex)        #10.047 son hombres (1) y 9.754 son mujeres (0)... tener en cuenta si esto 
```

## Descripción ...

Aquí va el texto
```{r description_5}
# # (7) Descripción de la variable de experiencia
# expp<- DGEIH$exp
# View(expp)
# class(expp)         #Aquí vemos la clase y nos dice que es numérica
# mean(expp)          #Aquí vemos la experiencia media y vemos es de 4.2 años
# min(expp)           #Aquí vemos la experiencia mínima y vemos que como era de esperar es de 0 años
# max(expp)           #Aquí vemos la experiencia máxima y vemos que es de 60 años
# modeExp <- function(expp){
#   return(as.numeric(names(which.max(table(expp)))))
# }
# modeExp(expp)       #Aquí vemos que la moda de la experiencia es de 0 años
# 
# 
# 
# ###########
# 
# # Crear el data frame
# datos_exp <- data.frame(expp)
# 
# # Crear el histograma
# histograma <- ggplot(datos_exp, aes(x = expp)) +
#   geom_histogram(binwidth = 1, fill = "#2E75B6", color = "white") +
#   labs(x = "Experiencia", y = "Frecuencia", title = "Histograma de Experiencia") +
#   theme_minimal() +
#   theme(plot.title = element_text(size = 16, face = "bold"),
#         axis.title = element_text(size = 14),
#         axis.text = element_text(size = 12))
# 
# # Mostrar el histograma
# print(histograma)
# 
# 
# 
# ###########
# 
# 
# plot(hist(expp))
# 
# 
# 
# # (8) Descripción de la variable de oficio
# library(modeest)
# Oficio_<- DGEIH$oficio
# class(Oficio_)
# levels(Oficio_)
# summary(Oficio_)
# table(Oficio_)
# barplot(table((Oficio_)))
# mlv(Oficio_, method = "mfv")
# 


```



## Age-wage profile

A great deal of evidence in Labor economics suggests that the typical worker’s age-wage profile has a predictable path: “Wages tend to be low when the worker is young; they rise as the worker ages, peaking at about age 50; and the wage rate tends to remain stable or decline slightly after age 50”

###  Estimate the Age-wage profile
$$
Log(w)=/beta_1+/beta_2Age+/beta_3Age^2+u
$$





This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


# Notas
Sustentar todas las medidas que salgan en las regresiones
Exportar salidas de regresión con stargazer