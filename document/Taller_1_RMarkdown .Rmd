---
title: "Problem Set 1 RMarkdown"
author: "Irina Vélez - Lucía Fillippo - Daniel Casas - Miguel Victoria"
date: "2023-06-21"
output: word_document
---
```{r setup, include=FALSE}
rm(list = ls())
# install pacman
if(!require(pacman)) install.packages("pacman") ; require(pacman)

## Automatiza cargue de paquetes
require(pacman)
p_load(rio, 
       tidyverse, 
       skimr,
       caret,
       rstudioapi,
       rvest,
       ggplot2) 
```

```{r path, include=FALSE}
rm(list=ls())
getwd()
path_sript <- rstudioapi::getActiveDocumentContext()$path
path_folder <- dirname(path_sript)
setwd(path_folder)
```

```{r Import_data, eval=FALSE, include=FALSE}
### Loading data  
data_url = "https://ignaciomsarmiento.github.io/GEIH2018_sample/pages/geih_"

# Loop
db_list <- lapply(1:10, function(i) {
  url <- paste0(data_url, "page_", i, ".html")
  page <- read_html(url) 
  tabla <- page %>% html_table
  db_geih <- data.frame(tabla)
})

db_geih <- do.call(rbind,db_list) # Concatenate the tables in a dataframe
view(db_geih)
```

```{r Transforming_data, eval=FALSE, include=FALSE}
##Filtering the data to those over 18 and employed (ocu=1)
# Details of the variable age 
summary(db_geih$age)
sum(is.na(db_geih$age)) # Checking for missing values
sum(is.na(db_geih$ocu))

db_geih_filtered <- db_geih[db_geih$age > 18 & db_geih$ocu == 1, ]
save(db_geih_filtered, file = "/Users/irina/Documents/Repositorios/PS1_Predicting_income/stores/data.Rdata")

## Dealing with missing values
# Count missing values for each column and sorting
missing_counts <- sapply(db_geih_filtered, function(x) sum(is.na(x)))
sorted_missing <- sort(missing_counts, decreasing = TRUE)
top_missing <- head(sorted_missing, 30)
top_missing

# Deleting the top missing variables and all variables that start with cclasnr
delete_var <- c("p550", "p7310", "p7350", "p7422", "p7422s1", "p7472", "p7472s1", "ina", "imdi", "imdies", "y_gananciaNetaAgro_m", "iof3ies", "y_accidentes_m", "p6585s4a2", "y_subEducativo_m", "isaes", "iof2es", "dominio", "clase")
delete_var2 <- grep("^cclasnr", names(db_geih_filtered), value = TRUE)
delete_t <- c(delete_var, delete_var2)

geih_filtered <- db_geih_filtered %>%
  select(-one_of(delete_t))

## Dealing with 0 wages

# Verification of the min and max value of the main resultant variables, and their missing values
summary(geih_filtered$p6500)           # Monthly labor income. DANE Variable
summary(geih_filtered$y_ingLab_m)      # labor income salaried nominal monthly
summary(geih_filtered$y_ingLab_m_ha)   # labor income salaried nominal hourly
summary(geih_filtered$y_salary_m)      # salary - nominal monthly
summary(geih_filtered$y_salary_m_hu)   # salary - real hourly (usual)

missing_income <- sum(is.na(geih_filtered$y_ingLab_m_ha))
obs <- nrow(geih_filtered)

# The 40.32% of the observations for the main resultant variables have missing values
missing_perc = (missing_income/obs)*100
missing_perc

missing_values <- is.na(geih_filtered$y_salary_m_hu)
missing_data <- geih_filtered[missing_values, c("estrato1", "maxEducLevel")]

missing_by_estrato <- table(missing_data$estrato1)
missing_by_educ <- table(missing_data$maxEducLevel)


missing_by_estrato <- sort(missing_by_estrato, decreasing = TRUE)
missing_by_educ <- sort(missing_by_educ, decreasing = TRUE)

missing_by_estrato_p <- missing_by_estrato / sum(missing_by_estrato) * 100
missing_by_educ_p <- missing_by_educ / sum(missing_by_educ) * 100

missing_by_estrato_p
missing_by_educ_p

# Data frame with the results
results <- data.frame(estrato = names(missing_by_estrato_p),
                      educacion = names(missing_by_educ_p),
                      p_missing_estrato = missing_by_estrato_p,
                      p_missing_educacion = missing_by_educ_p)

knitr::kable(results, caption = "Missing Values by Estrato and Educación")

geih_filtered <- geih_filtered[complete.cases(geih_filtered$y_salary_m_hu), ]
save(geih_filtered, file = "/Users/irina/Documents/Repositorios/PS1_Predicting_income/stores/data.Rdata")
```

```{r Import_DB, include=FALSE}
load("../stores/data.Rdata")
geih_filtered <- geih_filtered[complete.cases(geih_filtered$maxEducLevel), ]
```

# Taller 1

El presente informe presenta la solución al Problem Set 1 de la clase Big Data & Machine Learning, con el objetivo de aplicar diversos conceptos y herramientas para la predicción de modelos, el manejo de bases de datos grandes, entre otros. Para el desarrollo del trabajo se utilizó el repositorio GitHub el cual contiene información de la Gran Encuesta Integrada de Hogares - GEIH para el año 2018 (luego en word ponemos este hiperbínculo https://ignaciomsarmiento.github.io/GEIH2018_sample/); además, se empleó el sotware Rstudio para el manejo de los datos, generación de resultados y desarrollo del taller, cuyo código se encuentra en el siguiente link: (link del Github con el código)

## 1. Introducción

El valor de ingresos de las personas es un insumo esencial para el desarrollo de políticas públicas, ya sea para identificar a los hogares que tienen la posibilidad de pagar más impuestos, así como para lograr una mejor focalización en aquellos hogares que requieren apoyos sociales; no obstante, en algunas ocasiones los ingresos de las personas no son reportados, de manera que esto se convierte en una barrera para el desarrollo de políticas públicas eficientes. En virtud de lo anterior, poder determinar el valor de los ingresos de las personas se convierte en un gran insumo para el desarrollo de políticas tributarias y sociales, razón por la cual el objetivo principal de este documento es construir un modelo predictivo de los salarios por hora de los individuos, a partir del siguiente modelo:

$$
w=f(X)+u
$$

donde "w" representa el salario por hora y "X" es una matriz de potenciales variables que explican el salario. Como se mencionó previamente, para la creación de este modelo se utilizarán datos de la Gran Encuesta Integrada de Hogares – GEIH del año 2018. 

Para importar los datos, es importante conocer qué tipo de página web contiene la información, en este caso, la página web que contiene las bases de datos es dinámica, razón por la cual es pertinente identificar el link principal a partir del cual se realizará la extracción de la información. Para esto se aplicó un código en bucle para que la extracción de la informacíon de las distintas ventanas de la página web fuese más eficiente; además, se realizaron una serie de filtros a los datos, siguiendo las instrucciones dadas, con la finalidad de eliminar las variables "N/A" y considerar únicamente a los individuos mayores de 18 años.

# Descripción de los datos
## Descripción general

Aquí va el texto
```{r general_description, echo=FALSE}
# Aquí hacemos la clasificación de variables
exp <- floor(c(geih_filtered$p6426/12)) #Ponemos anual la variable de experiencia
DGEIH<-subset(geih_filtered, select = c( "y_salary_m_hu", "pet", "mes", "age", "sex","ocu", "oficio", "maxEducLevel","totalHoursWorked")) 

#Hacemos un subset con las variables a usar
DGEIH<-cbind(DGEIH, exp) #Incluimos las variables calculadas que revisaremos

summary(DGEIH)

```

<<<<<<< HEAD

## Análisis descriptivo
=======

De manera general, se identifica que nuestra base de datos está compuesta por 9.784 filas y por 151 columnas. Las variables que hacen parte de la base son: 

- (y_salary_m_hu): Indica el salario mensual por hora de la persona
- (pet): Indica si la persona hace parte de la Población en Edad de Trabajar - PET
- (mes): Contiene el mes de referencia
- (age): Contiene la edad de la persona
- (sex): Contiene el sexo de la persona
- (ocu): Señala si la persona es ocupada o no ocupada
- (oficio): Indica el oficio de la persona
- (maxEducLevel): Indicar el máximo nivel educativo alcanzado
- (totalHoursWorked): Indica el total de horas trabajadas en el último mes
- (exp): Hace referencia a la experiencia en años que tiene la persona

```{r age_description_1, echo=FALSE}
# (1) Descripción general de la base
dimen_dgeih <- dim(geih_filtered)  #Número de filas y columnas
dimen_dgeih
# Obtener los nombres de las variables
nombres_variables <- names(geih_filtered)
# Imprimir los nombres de las variables
print(nombres_variables)
```

Dicho lo anterior, a continuación se procede a realizar una descripción más amplia y gráfica de las variables que harán parte del modelo.

=======
## Descripción edad
=======

```{r age_description_2, echo=FALSE}
# (2) Descripción de la variable de edad
Edad<- geih_filtered$age
edad_clas <- class(Edad)        #Aquí vemos la clase que es de números enteros (integer)
edad_clas
summary(Edad)
modeEdad <- function(Edad){
  return(as.numeric(names(which.max(table(Edad)))))
}
edad_mod <- modeEdad(Edad)      #La moda de la edad
modeEdad(Edad)
```
La variable de edad es una variable con números enteros donde se observa un mínimo de 19 años, lo cual guarda sentido con la filtración inicial de los datos, donde se tuvo en cuenta únicamente a las personas mayores de 18 años, y en contraste se identifica un máximo de 86 años. En el primer cuartil de la base se observa una edad de 27 años, en el tercer cuartil una de 45 años. La mediana de los datos es de 34 años, la media es de 36 años y la moda es de 24 años. A continuación se presenta una gráfica de barras que permite observar la distribución de la edad a lo largo de la muestra, donde se identifica que, en general, se cuenta con una población relativamente joven.

```{r age_description, echo=FALSE}
# Ahora haremos un diagrama de barras 
# Crearemos un data frame con los datos de edad
datos_edad <- data.frame(Edad)

# Crearemos el diagrama de barras
bar_chart <- ggplot(datos_edad, aes(x = Edad)) +
  geom_bar(fill = "#2E75B6", color = "white") +
  labs(x = "Edad", y = "Frecuencia", title = "Distribución de Edad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

# Que nos muestre el diagrama de barras
print(bar_chart)
```

=======
## Descripción ocupación
=======

La variable de ocupación es una dummy que toma el valor de "1" si la persona está ocupada y "0" si no lo está. Inicialmente en la base sin filtrar se tenía una distribución de ocupación con 16.277 personas ocupadas y 3.524 no ocupadas, como la que se observa a continuación:

```{r ocup_description, echo=FALSE}
# (4) Descripción de la variable de ocupación
#Creamos un data frame con los datos de ocupación
datos_ocu <- data.frame(
  Categoría = c("Ocupadas", "No Ocupadas"),
  Cantidad = c(16277, 3524)
)

#Calculamos los porcentajes
datos_ocu$Porcentaje <- round(datos_ocu$Cantidad / sum(datos_ocu$Cantidad) * 100, 1)

#Creamos el diagrama de pie
pie_chart <- ggplot(datos_ocu, aes(x = "", y = Cantidad, fill = Categoría)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        plot.margin = margin(0, 0, 0, 0)) +
  geom_text(aes(label = paste0(Categoría, "\n", Porcentaje, "%")), 
            position = position_stack(vjust = 0.5), size = 3, color = "white")
print(pie_chart)
```


Ahora bien, como resultado de la filtración inicial llevada a cabo, y siguiendo la instrucción impartida, la base de datos final únicamente se cuenta con personas mayores de 18 años ocupadas lo que da como resultado un total de 9.784 personas ocupadas.

```{r ocup_description, echo=FALSE}
# (4) Descripción de la variable de ocupación
ocu<- geih_filtered$ocu
summary(ocu)
length(ocu)
ocup_clas <- class(ocu)          #Aquí vemos la clase y nos dice que es categórica (factor)
ocup_clas
ocup_clas <- levels(ocu)         #Como es categórica y tiene nivel 0 y 1         
ocup_clas
```

## Descripción educación

La variable de educación es categórica y tiene la siguiente clasificación por categorías:


1. Ninguno: Que corresponde a aquellas personas sin educación
2 Preescolar: Que corresponde a aquellas personas que solamente terminaron preescolar
3 Basica primaria: Que corresponde a aquellas personas que solo terminaron básica primaria, esto es, los grados de primero a quinto
4 Basica secundaria: Que corresponde a aquellas personas que solo terminaron básica secundaria, esto es, los grados de secto a noveno
5 Media: Que corresponde a aquellas personas que solo terminaron la educación media, esto es, los grados de noveno a once
6 Superior - Universitaria: Que corresponde a aquellas personas que terminaron educación superior y/o universitaria
7 No sabe, No informa

Dicho lo anterior, el análisis de esta variable muestra que la media y la mediana son personas que tienen educación universitaria, lo cual guarda sentido con que sean aquellas que han podido acceder al mercado laboral y encontrarse ocupadas.

```{r educ_description, echo=FALSE}

educ<- geih_filtered$maxEducLevel
educ_cals <- class(educ)
educ_cals
summary(educ)
modeEduc <- function(educ){
  return(as.numeric(names(which.max(table(educ)))))
}
mod_educ <- modeEduc(educ)      #La moda de la educación es 7 (terciary)
mod_educ

```

Lo anterior se puede constatar de manera visual en la siguiente gráfica de barras, donde se muestra la manera en que se encuentra distribuida la variable de educación, de acuerdo con la base de datos obtenida:


```{r educ_description, echo=FALSE}

# Creamos el data frame
datos_educ <- data.frame(educ)

# Creamos el diagrama de barras con etiquetas de datos y demás
bar_chart <- ggplot(datos_educ, aes(x = as.factor(educ))) +
  geom_bar(fill = "#2E75B6", color = "white") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 3, color = 'black') +  # Agregar etiquetas de datos
  labs(x = "Educ", y = "Frecuencia", title = "Distribución de Educación") +
  scale_x_discrete(labels = c("Ninguna", "Preescolar", "Primaria", "Secundaria", "Media", "Universitaria", "No_informa")) +  # Cambiar las categorías del eje x
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 7),
        axis.line.y = element_blank(),  # Eliminar el eje vertical izquierdo
        axis.ticks.y = element_blank(),  # Eliminar los ticks del eje vertical izquierdo
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

# Hacemos que nos muestre el diagrama de barras
print(bar_chart)
summary(educ)
table(educ)
```

## Descripción sexo

La variable de género es dummy y toma el valor de 0 si la persona es mujer y toma el valor de 1 si es hombre. Los datos reflejan un total de 4.909 hombres y 4.875 mujeres, como se muestra en la siguiente gráfica de pie.

```{r sex_description, echo=FALSE}
summary(geih_filtered$sex)
sex<- geih_filtered$sex
sex_clas <- class(sex)      #Aquí vemos la clase y nos dice que es integer, es una variable dummy
sex_tabl <- table(sex)
# Creamos un data frame con los datos de sexo
datos_sex <- data.frame(
  Categoría = c("Hombres", "Mujeres"),
  Cantidad = c(4909, 4875)
)

# Crear el diagrama de pie con etiquetas de datos
pie_chart <- ggplot(datos_sex, aes(x = "", y = Cantidad, fill = Categoría)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  geom_text(aes(label = Cantidad), position = position_stack(vjust = 0.5), size = 4) +  # Etiquetas de datos en valores enteros
  coord_polar("y", start = 0) +
  labs(title = "Distribución por género") +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        legend.position = "right")

# Mostrar el diagrama de pie
print(pie_chart)
table(sex)
```

## Descripción de la experiencia

La variable de experiencia es continua e indica los meses que lleva trabajando la persona en su trabajo actual. La mediana y la moda de esta variable es de 24 meses, la media de 50 meses,  y el valor máximo es de 696 meses.

```{r exp_description, echo=FALSE}
expp <- geih_filtered$p6426
expp<- geih_filtered$p6426
class(expp)         #Aquí vemos la clase y nos dice que es numérica
summary(expp)
modeExp <- function(expp){
   return(as.numeric(names(which.max(table(expp)))))
 }
modeExp(expp)       #Que me muestre la moda
```
En virtud de lo anterior, el siguiente histograma refleja la distribución de la experiencia, donde se observa que la mayoría de observaciones se ubican entre 0 y 50 meses, lo cual guarda sentido con que los datos de media señalados previamente.

```{r exp_description, echo=FALSE}
# Generar el histograma
histograma <- hist(geih_filtered$p6426, breaks = seq(0, 700, by = 50), col = "#2E75B6", border = "white",
                   xlab = "Experiencia (meses)", ylab = "Frecuencia", main = "Histograma de Experiencia")

# Personalizar la apariencia del histograma
par(las = 1)  # Orientación de etiquetas de ejes
box()  # Agregar un marco alrededor del histograma

```


## Age-wage profile

A great deal of evidence in Labor economics suggests that the typical worker’s age-wage profile has a predictable path: “Wages tend to be low when the worker is young; they rise as the worker ages, peaking at about age 50; and the wage rate tends to remain stable or decline slightly after age 50”

###  Estimate the Age-wage profile
$$
Log(w)=/beta_1+/beta_2Age+/beta_3Age^2+u
$$





This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


# Notas
Sustentar todas las medidas que salgan en las regresiones
Exportar salidas de regresión con stargazer